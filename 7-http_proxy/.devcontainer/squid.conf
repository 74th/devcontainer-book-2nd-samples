# ログ（必要に応じてローテーション設定）
cache_access_log /var/log/squid/access.log
cache_log        /var/log/squid/cache.log

# キャッシュは用途次第。まずは最小限（ほぼ透過させたいなら 0 でもOK）
cache_mem 64 MB
maximum_object_size_in_memory 512 KB
cache_dir ufs /var/spool/squid 256 16 256

# ルーティング：原則プロキシを経由して外へ
dns_v4_first on
dns_nameservers 8.8.8.8 1.1.1.1

# ポート
http_port 3128

# 既定ACL（ポート制限）
acl SSL_ports port 443         # HTTPS
acl Safe_ports port 80         # HTTP
acl Safe_ports port 443        # HTTPS

# クライアント範囲（dev-network からのアクセスのみ許可）
# Docker のブリッジで典型的なプライベート帯域。必要に応じて絞ってOK。
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16
acl localnet src 10.0.0.0/8

# ===== ホワイトリスト方式 =====
# 許可ドメインは別ファイル管理（ワイルドカード .example.com のように書く）
acl whitelist dstdomain "/etc/squid/allow_domains.txt"

# HTTP の許可（宛先が Safe_ports で、許可ドメインのみ）
http_access allow localnet whitelist
# HTTPS の許可（CONNECT 先ドメインを whitelist で制限）
# 明示的プロキシの CONNECT は SNI ではなく「CONNECT ホスト名」を見られるので dstdomain マッチ可
http_access allow localnet CONNECT whitelist

# それ以外は遮断
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access deny all

# HTTP/1.1 周りの互換性（必要に応じて）
via on
forwarded_for on
request_header_max_size 64 KB
reply_header_max_size   64 KB

# パフォーマンス/安定（任意）
pipeline_prefetch on